<!--
**********************************************************************************
THIS PAGE MUST INCLUDE:
**********************************************************************************
 - A redirection to this page when the product is selected in gamelist AND/OR 
   categories!
 - The ability to specify the number of items or product attributes before adding
   to the cart!
 - Products displayed must have original and promotional price visible at ALL
   TIMES and on EVERY PAGE!
**********************************************************************************
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Details</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="assets/js/navbar.js"></script>
    <style>
        /* Game details page styles */
        /* Game details page styles */
body {
    background-color: #250101;
    color: #fff;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 10px 20px;
}

.gamepage {
    background-color: #700000; /* Dark red/maroon background */
    border-radius: 4px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    color: #fff;
    overflow: hidden;
    padding: 20px;
}

.game-content {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 20px;
}

.game-image-container {
    flex: 0 0 100%;
    max-width: 600px;
    background: linear-gradient(to bottom, #2C2C2C 0%, #281616 100%, #250101 100%);
    border-radius: 15px;
    overflow: hidden;
    padding: 15px;
}

.game-image {
    width: 100%;
    height: auto;
    border-radius: 2px;
}

.game-details {
    flex: 1;
    min-width: 300px;
    background: linear-gradient(to bottom, #2C2C2C 0%, #281616 100%, #250101 100%);
    border-radius: 15px;
    padding: 15px 20px;
}

.game-title {
    font-size: 24px;
    font-weight: bold;
    margin: 0 0 15px 0;
}

.game-description {
    line-height: 1.6;
    margin-bottom: 20px;
}

.game-meta {
    margin-bottom: 15px;
}

.game-meta span {
    margin-right: 15px;
    color: #ddd;
    font-size: 14px;
}

.game-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 20px 0;
}

.game-tag {
    background-color: #333;
    color: #fff;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 14px;
    display: flex;
    align-items: center;
}

.game-tag::before {
    content: "✓";
    margin-right: 5px;
    color: white;
}

.purchase-section {
    margin-top: 20px;
    background: linear-gradient(to top, #2C2C2C 0%, #281616 100%, #250101 100%);
    border-radius: 15px;
    padding: 15px 20px;
}

.purchase-title {
    font-size: 18px;
    margin-bottom: 15px;
}

.price-container {
    margin-bottom: 15px;
}

.current-price {
    font-size: 22px;
    font-weight: bold;
    color: #fff;
}

.original-price {
    font-size: 16px;
    color: #999;
    text-decoration: line-through;
    margin-right: 10px;
}

.discount-badge {
    background-color: #cc0000;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: bold;
    display: inline-block;
    margin-right: 10px;
}

.quantity-selector {
    margin-bottom: 15px;
}

.quantity-selector label {
    margin-right: 10px;
}

.quantity-selector select {
    padding: 8px;
    background-color: #333;
    color: #fff;
    border: 1px solid #444;
    border-radius: 4px;
}

.add-to-cart-btn {
    background-color: #ff3333;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.2s;
    width: 100%;
    margin-bottom: 10px;
}

.add-to-cart-btn:hover {
    background-color: #e60000;
}

/* Platform/feature tags */
.platform-tags {
    display: flex;
    gap: 15px;
    margin-top: 15px;
}

.platform-tag {
    background-color: #333;
    color: #fff;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 14px;
    display: flex;
    align-items: center;
}

.platform-tag::before {
    content: "✓";
    margin-right: 5px;
    color: white;
}

/* Navigation */
.game-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #222;
    padding: 10px 15px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.nav-buttons {
    display: flex;
    gap: 10px;
}

.nav-button {
    background-color: #333;
    border: none;
    color: #fff;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
}

.nav-button:hover {
    background-color: #444;
}

.nav-dropdown {
    position: relative;
}

.nav-dropdown select {
    background-color: #ffffff;
    color: #000;
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.user-section {
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #555;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .game-content {
        flex-direction: column;
    }
    
    .game-image-container,
    .game-details {
        flex: 0 0 100%;
        max-width: 100%;
    }
    
    .nav-buttons {
        flex-wrap: wrap;
    }
}
    </style>
</head>
<body>
    <!-- Calls the Navbar -->
    <div id="navbar-container"></div>
    
    <div class="container">
          <div class="game-content">
              <div class="game-image-container">
                  <img id="game-image" class="game-image" src="" alt="">
              </div>
              
              <div class="game-details">
                  <h2 id="game-title" class="game-title"></h2>
                  
                  <div id="game-meta" class="game-meta">
                      <!-- This will be populated by JavaScript -->
                  </div>
                  
                  <div id="game-description" class="game-description">
                      <!-- This will be populated by JavaScript -->
                  </div>
                  
                  <div id="game-tags" class="game-tags">
                      <!-- This will be populated by JavaScript -->
                  </div>
              </div>
          </div>
          
          <div class="purchase-section">
              <h3 class="purchase-title">Add Game to Cart</h3>
              
              <div class="price-container">
                  <span id="discount-badge" class="discount-badge"></span>
                  <span id="original-price" class="original-price"></span>
                  <span id="current-price" class="current-price"></span>
              </div>
              
              <div class="platform-tags">
                  <!-- This will be populated by JavaScript -->
              </div>
              
              <div class="quantity-selector">
                  <label for="quantity">Quantity:</label>
                  <select id="quantity" name="quantity">
                      <!-- This will be populated by JavaScript -->
                  </select>
              </div>
              
              <button id="add-to-cart-btn" class="add-to-cart-btn">Add to Cart</button>
              
          </div>
      </div>
  </div>
    <script>
   document.addEventListener('DOMContentLoaded', async function () {
    const gameId = new URLSearchParams(window.location.search).get("id");

    if (!gameId) {
        document.querySelector(".gamepage").innerHTML = '<div class="error">Game ID missing in URL.</div>';
        return;
    }

    try {
        const response = await fetch(`http://localhost:3000/api/games/${gameId}`);
        if (!response.ok) {
            throw new Error('Failed to fetch game details');
        }
        const game = await response.json();
        
        // Display game details
        displayGameDetails(game);
    } catch (error) {
        console.error("Error fetching game details:", error);
        document.querySelector(".gamepage").innerHTML = `<div class="error">Error loading game: ${error.message}</div>`;
    }
});

function displayGameDetails(game) {
    // Set the game title
    document.getElementById('game-title').textContent = game.title;
    
    // Set the game image
    document.getElementById('game-image').src = game.thumbnail;
    document.getElementById('game-image').alt = game.title;
    
    // Format the release date
    const releaseDate = new Date(game.release_date).toLocaleDateString();
    
    // Set the meta information
    const metaInfoHTML = `
        <span>Developer: ${game.developer || 'Unknown'}</span>
        <span>Released: ${releaseDate}</span>
    `;
    document.getElementById('game-meta').innerHTML = metaInfoHTML;
    
    // Set the game description
    document.getElementById('game-description').innerHTML = game.description || 'No description available.';
    
    // Convert price values to numbers
    const price = parseFloat(game.price) || 0;
    const promoPrice = parseFloat(game.promo_price) || price;
    
    // Set the price information
    if (promoPrice < price) {
        const discountPercent = Math.round((1 - promoPrice / price) * 100);
        document.getElementById('discount-badge').textContent = `-${discountPercent}%`;
        document.getElementById('original-price').textContent = `$${price.toFixed(2)}`;
    } else {
        document.getElementById('discount-badge').style.display = 'none';
        document.getElementById('original-price').style.display = 'none';
    }
    document.getElementById('current-price').textContent = `$${promoPrice.toFixed(2)}`;
    
    // Generate game tags
    let tagsHTML = '';
    if (game.categories && game.categories.length > 0) {
        game.categories.forEach(category => {
            tagsHTML += `<div class="game-tag">${category}</div>`;
        });
    } else if (game.category) {
        tagsHTML += `<div class="game-tag">${game.category}</div>`;
    }
    document.getElementById('game-tags').innerHTML = tagsHTML;
    
    // Generate platform tags (assuming Java in this example, customize as needed)
    const platformHTML = `
        <div class="platform-tag">Java</div>
    `;
    document.querySelector('.platform-tags').innerHTML = platformHTML;
    
    // Generate quantity options
    let quantityOptions = '';
    for (let i = 1; i <= 10; i++) {
        quantityOptions += `<option value="${i}">${i}</option>`;
    }
    document.getElementById('quantity').innerHTML = quantityOptions;
    
    // Set up event listeners for buttons
    document.getElementById('add-to-cart-btn').onclick = function() {
        addToCart(game.id || game.game_id);
    };
    
}

async function addToCart(gameId) {
    const quantity = parseInt(document.getElementById('quantity').value, 10);
    
    // Get user authentication data
    const token = localStorage.getItem("token");

    if (!token) {
        alert("You need to be logged in to add items to cart.");
        return;
    }

    try {
        const response = await fetch("http://localhost:3000/api/cart/add", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ game_id: gameId, quantity: quantity })
        });

        const data = await response.json();

        if (response.ok) {
            alert("Game added to cart successfully!");
        } else {
            alert("Error: " + data.message);
        }
    } catch (error) {
        console.error("Error adding to cart:", error);
        alert("An error occurred. Please try again.");
    }
}



  </script>
</body>
</html>